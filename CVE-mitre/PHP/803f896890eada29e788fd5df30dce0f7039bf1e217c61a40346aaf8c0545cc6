--- CHANGELOG.md ---
@@ -1,5 +1,9 @@
 # Release Notes for Craft CMS 4
 
+## Unreleased
+
+- Fixed an RCE vulnerability.
+
 ## 4.13.1.1 - 2024-11-18
 
 - Fixed a PHP error. ([#16142](https://github.com/craftcms/cms/issues/16142))

--- bootstrap/bootstrap.php ---
@@ -27,8 +27,15 @@
 // Determine the paths
 // -----------------------------------------------------------------------------
 
-$findConfig = function(string $cliName, string $envName) {
-    return App::cliOption($cliName, true) ?? App::env($envName);
+$findConfig = function(string $cliName, string $envName) use ($appType) {
+    if ($appType === 'console') {
+        $value = App::cliOption($cliName, true);
+        if ($value !== null) {
+            return $value;
+        }
+    }
+
+    return App::env($envName);
 };
 
 // Set the vendor path. By default assume that it's 4 levels up from here
@@ -49,11 +56,7 @@
 // Set the environment
 // -----------------------------------------------------------------------------
 
-$environment = App::cliOption('--env', true)
-    ?? App::env('CRAFT_ENVIRONMENT')
-    ?? App::env('ENVIRONMENT')
-    ?? $_SERVER['SERVER_NAME']
-    ?? null;
+$environment = $findConfig('--env', 'CRAFT_ENVIRONMENT') ?? App::env('ENVIRONMENT') ?? $_SERVER['SERVER_NAME'] ?? null;
 
 // Load the general config
 // -----------------------------------------------------------------------------

