--- CHANGELOG.rst ---
@@ -5,6 +5,11 @@ Change log
 Next version
 ============
 
+- **Vulnerability:** Fixed an issue where normalizing unicode too late in the
+  process would keep disallowed tags when using specially crafted HTML. Fixed
+  in 2.4.2.
+
+
 2.4 (2024-04-01)
 ================
 

--- html_sanitizer/sanitizer.py ---
@@ -250,6 +250,12 @@ def sanitize(self, html):
         Requires ``lxml`` and, for especially broken HTML, ``beautifulsoup4``.
         """
 
+        # normalize unicode
+        if self.keep_typographic_whitespace:
+            html = unicodedata.normalize("NFC", html)
+        else:
+            html = unicodedata.normalize("NFKC", html)
+
         html = normalize_overall_whitespace(
             html,
             keep_typographic_whitespace=self.keep_typographic_whitespace,
@@ -420,10 +426,4 @@ def sanitize(self, html):
         # remove wrapping tag needed by XML parser
         html = re.sub(r"^<div>|</div>$", "", html)
 
-        # normalize unicode
-        if self.keep_typographic_whitespace:
-            html = unicodedata.normalize("NFC", html)
-        else:
-            html = unicodedata.normalize("NFKC", html)
-
         return html

--- html_sanitizer/tests.py ---
@@ -655,3 +655,13 @@ def test_br_attribute_sanitization(self):
                 ("<br hello=\"alert('world');\"/><br>", "<br>"),
             ]
         )
+
+    def test_normalize_early(self):
+        self.run_tests(
+            [
+                (
+                    "\uff1cimg src=x onerror=\uff02alert(window.location)\uff02\uff1e",
+                    "",
+                ),
+            ]
+        )

