--- hphp/runtime/ext/gd/ext_gd.cpp ---
@@ -7117,6 +7117,10 @@ static int exif_scan_JPEG_header(image_info_type *ImageInfo) {
       case M_SOF13:
       case M_SOF14:
       case M_SOF15:
+        if ((itemlen - 2) < 6) {
+          return 0;
+        }
+
         exif_process_SOFn(Data, marker, &sof_info);
         ImageInfo->Width  = sof_info.width;
         ImageInfo->Height = sof_info.height;

--- hphp/test/slow/ext_gd/exifreaddata.php ---
@@ -0,0 +1,8 @@
+<?hh
+
+<<__EntryPoint>>
+function main_exifreaddata() {
+  $jpeg = "\xff\xd8\xc9\x00\x03\x04\x03\xf8";
+  $data_stream = "data://text/plain;base64," . base64_encode($jpeg);
+  var_dump(exif_read_data($data_stream));
+}

--- hphp/test/slow/ext_gd/exifreaddata.php.expectf ---
@@ -0,0 +1,2 @@
+Warning: Invalid JPEG file in %s/ext_gd/exifreaddata.php on line 7
+bool(false)

