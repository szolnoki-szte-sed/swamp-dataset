--- hphp/runtime/base/zend-string.cpp ---
@@ -626,8 +626,14 @@ String string_chunk_split(const char *src, int srclen, const char *end,
   int chunks = srclen / chunklen; // complete chunks!
   int restlen = srclen - chunks * chunklen; /* srclen % chunklen */
 
-  int out_len = (chunks + 1) * endlen + srclen;
-  String ret(out_len, ReserveString);
+  String ret(
+    safe_address(
+      chunks + 1,
+      endlen,
+      srclen
+    ),
+    ReserveString
+  );
   char *dest = ret.bufferSlice().ptr;
 
   const char *p; char *q;

--- hphp/test/slow/ext_string/chunk_split_overflow.php ---
@@ -0,0 +1,3 @@
+<?php
+
+chunk_split(str_repeat('*', 2000000), 1.0, str_repeat('*', 2000000));

--- hphp/test/slow/ext_string/chunk_split_overflow.php.expectf ---
@@ -0,0 +1,2 @@
+
+Fatal error: String length exceeded 2^31-2: 4000004000000 in %s on line 3

