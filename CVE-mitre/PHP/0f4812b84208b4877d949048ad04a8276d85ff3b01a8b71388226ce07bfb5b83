--- functions/attachment.php ---
@@ -554,3 +554,50 @@ function bodhi_svgs_cleanup_duplicate_meta() {
         $offset += $batch_size;
     } while (count($query->posts) === $batch_size);
 }
+
+function bodhi_svgs_handle_upload_check($fileinfo) {
+    if ($fileinfo['type'] === 'image/svg+xml') {
+        global $bodhi_last_upload_info;
+        $bodhi_last_upload_info = $fileinfo;
+    }
+    return $fileinfo;
+}
+add_filter('wp_handle_upload', 'bodhi_svgs_handle_upload_check');
+
+function bodhi_svgs_rest_insert_attachment($prepared_attachment, $request) {
+    if ($request->get_header('content-type') !== 'image/svg+xml') {
+        return $prepared_attachment;
+    }
+    
+    global $bodhi_svgs_options;
+    $user = wp_get_current_user();
+    $current_user_roles = (array) $user->roles;
+    $sanitize_on_upload_roles_array = (array) $bodhi_svgs_options['sanitize_on_upload_roles'];
+    
+    $should_sanitize = empty(array_intersect($sanitize_on_upload_roles_array, $current_user_roles));
+    
+    if ($should_sanitize) {
+        $file_path = get_attached_file($prepared_attachment->ID);
+        if (!$file_path) {
+            global $bodhi_last_upload_info;
+            if (isset($bodhi_last_upload_info['file'])) {
+                $file_path = $bodhi_last_upload_info['file'];
+            }
+        }
+        
+        if ($file_path && file_exists($file_path)) {
+            global $sanitizer;
+            $file_content = file_get_contents($file_path);
+            
+            if ($file_content !== false) {
+                $clean_svg = $sanitizer->sanitize($file_content);
+                if ($clean_svg !== false) {
+                    file_put_contents($file_path, $clean_svg);
+                }
+            }
+        }
+    }
+    
+    return $prepared_attachment;
+}
+add_filter('rest_insert_attachment', 'bodhi_svgs_rest_insert_attachment', 10, 2);

--- readme.txt ---
@@ -3,15 +3,14 @@ Contributors: Benbodhi
 Donate link: https://www.paypal.com/cgi-bin/webscr?cmd=_s-xclick&hosted_button_id=Z9R7JERS82EQQ
 Tags: svg, vector, safe svg, sanitization, mime type
 Requires at least: 5.8
-Tested up to: 6.7.2
+Tested up to: 6.7.3
 Requires PHP: 7.4
 Stable tag: 2.5.10
 License: GPLv2 or later
 License URI: http://www.gnu.org/licenses/gpl-2.0.html
 
 Securely upload SVG files to your media library, with built-in sanitization and advanced features for styling and animation.
 
-
 == Description ==
 
 **The complete SVG solution for WordPress - secure, flexible, and easy to use.**
@@ -152,6 +151,10 @@ You need to add the mime type for svg and svgz to: "MLA Settings > Media Library
 
 == Changelog ==
 
+= 2.5.11 =
+* **Security Enhancement**
+    - Added more effective handling of sanitization for REST API uploads
+
 = 2.5.10 =
 * **Fixes**:
     - Fixed issue with upload checks preventing plugin uploads
@@ -463,6 +466,9 @@ You need to add the mime type for svg and svgz to: "MLA Settings > Media Library
 
 == Upgrade Notice ==
 
+= 2.5.11 =
+Security update: added more effective handling of sanitization for REST API uploads
+
 = 2.5.10 =
 Fixed issue with upload checks preventing plugin uploads
 

--- svg-support.php ---
@@ -3,7 +3,7 @@
 Plugin Name: 	SVG Support
 Plugin URI:		http://wordpress.org/plugins/svg-support/
 Description: 	Upload SVG files to the Media Library and render SVG files inline for direct styling/animation of an SVG's internal elements using CSS/JS.
-Version: 		2.5.10
+Version: 		2.5.11
 Author URI: 	https://benbodhi.com
 Text Domain: 	svg-support
 Domain Path:	/languages

