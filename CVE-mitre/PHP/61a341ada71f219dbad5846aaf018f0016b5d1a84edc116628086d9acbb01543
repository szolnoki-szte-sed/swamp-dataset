--- hphp/runtime/ext/json/JSON_parser.cpp ---
@@ -1148,6 +1148,10 @@ bool JSON_parser(Variant &z, const char *p, int length, bool const assoc,
   // they exceed kMaxPersistentStringBufferCapacity at exit or if the thread
   // is explicitly flushed (e.g., due to being idle).
   json->initSb(length);
+  if (depth <= 0) {
+    json->error_code = json_error_codes::JSON_ERROR_DEPTH;
+    return false;
+  }
   SCOPE_EXIT {
     constexpr int kMaxPersistentStringBufferCapacity = 256 * 1024;
     if (json->sb_cap > kMaxPersistentStringBufferCapacity) json->flushSb();

--- hphp/test/slow/ext_json/decode_crash.php ---
@@ -0,0 +1,3 @@
+<?hh
+
+var_dump(json_decode('"a"', false, 0, 0));

--- hphp/test/slow/ext_json/decode_crash.php.expect ---
@@ -0,0 +1 @@
+NULL

