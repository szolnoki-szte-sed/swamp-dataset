--- files-edit.php ---
@@ -6,6 +6,7 @@
 
 $allowed_levels = array(9, 8, 7, 0);
 require_once 'bootstrap.php';
+log_in_required($allowed_levels);
 
 $active_nav = 'files';
 

--- groups-add.php ---
@@ -4,6 +4,7 @@
  */
 $allowed_levels = array(9, 8);
 require_once 'bootstrap.php';
+log_in_required($allowed_levels);
 
 $active_nav = 'groups';
 

--- groups-edit.php ---
@@ -4,6 +4,7 @@
  */
 $allowed_levels = array(9, 8);
 require_once 'bootstrap.php';
+log_in_required($allowed_levels);
 
 $active_nav = 'groups';
 

--- groups.php ---
@@ -4,6 +4,7 @@
  */
 $allowed_levels = array(9, 8);
 require_once 'bootstrap.php';
+log_in_required($allowed_levels);
 
 $active_nav = 'groups';
 

--- header.php ---
@@ -8,12 +8,6 @@
  */
 if (!defined('VIEW_TYPE')) define('VIEW_TYPE', 'private');
 
-// Check for an active session
-redirect_if_not_logged_in();
-
-// Check if the current user has permission to view this page.
-redirect_if_role_not_allowed($allowed_levels);
-
 global $flash;
 
 /** If no page title is defined, revert to a default one */

--- import-orphans.php ---
@@ -9,6 +9,7 @@
  */
 $allowed_levels = array(9, 8, 7);
 require_once 'bootstrap.php';
+log_in_required($allowed_levels);
 
 $active_nav = 'files';
 $this_page = 'import-orphans.php';

--- includes/actions.log.export.php ---
@@ -4,8 +4,7 @@
  */
 $allowed_levels = array(9);
 require_once '../bootstrap.php';
-
-redirect_if_role_not_allowed($allowed_levels);
+log_in_required($allowed_levels);
 
 header('Content-Type: text/csv; charset=utf-8');
 header('Content-Disposition: attachment; filename=data.csv');

--- includes/cron.log.export.php ---
@@ -4,8 +4,7 @@
  */
 $allowed_levels = array(9);
 require_once '../bootstrap.php';
-
-redirect_if_role_not_allowed($allowed_levels);
+log_in_required($allowed_levels);
 
 header('Content-Type: text/csv; charset=utf-8');
 header('Content-Disposition: attachment; filename=cron-log.csv');

--- includes/functions.session.permissions.php ---
@@ -4,7 +4,16 @@
  * client or user.
  */
 
- function extend_session()
+function log_in_required($allowed_levels)
+{
+    // Check for an active session
+    redirect_if_not_logged_in();
+
+    // Check if the current user has permission to view this page.
+    redirect_if_role_not_allowed($allowed_levels);
+}
+
+function extend_session()
 {
     $_SESSION['last_call'] = time();
 }

--- manage-downloads.php ---
@@ -6,6 +6,8 @@
  */
 $allowed_levels = array(9, 8, 7, 0);
 require_once 'bootstrap.php';
+log_in_required($allowed_levels);
+
 $active_nav = 'files';
 
 $page_title = __('Manage downloads', 'cftp_admin');

--- manage-files.php ---
@@ -6,6 +6,8 @@
  */
 $allowed_levels = array(9, 8, 7, 0);
 require_once 'bootstrap.php';
+log_in_required($allowed_levels);
+
 $active_nav = 'files';
 
 $page_title = __('Manage files', 'cftp_admin');

--- options.php ---
@@ -4,6 +4,7 @@
  */
 $allowed_levels = array(9);
 require_once 'bootstrap.php';
+log_in_required($allowed_levels);
 
 $section = (!empty($_GET['section'])) ? $_GET['section'] : $_POST['section'];
 
@@ -16,6 +17,7 @@
             'xsendfile_enable',
             'footer_custom_enable',
             'files_default_expire',
+            'files_default_public',
             'uploads_organize_folders_by_date',
             'files_descriptions_use_ckeditor',
             'use_browser_lang',
@@ -121,6 +123,7 @@
     /** Values that can be empty */
     $allowed_empty_values = [
         'footer_custom_content',
+        'custom_download_uri',
         'mail_copy_addresses',
         'mail_smtp_host',
         'mail_smtp_port',

--- process.php ---
@@ -6,6 +6,7 @@
 /** Process an action */
 $allowed_levels = array(9, 8, 7, 0);
 require_once 'bootstrap.php';
+log_in_required($allowed_levels);
 
 global $auth;
 global $logger;

--- templates.php ---
@@ -4,6 +4,7 @@
  */
 $allowed_levels = array(9);
 require_once 'bootstrap.php';
+log_in_required($allowed_levels);
 
 $page_title    = __("Templates", 'cftp_admin');
 

--- unblock-ip.php ---
@@ -4,6 +4,7 @@
  */
 $allowed_levels = array(9);
 require_once 'bootstrap.php';
+log_in_required($allowed_levels);
 
 $page_title = __('Unblock IP', 'cftp_admin');
 

--- upload.php ---
@@ -18,6 +18,7 @@
 if (get_option('clients_can_upload') == 1) {
     $allowed_levels[] = 0;
 }
+log_in_required($allowed_levels);
 
 if (LOADED_LANG != 'en') {
     $plupload_lang_file = 'vendor/moxiecode/plupload/js/i18n/' . LOADED_LANG . '.js';

--- users-add.php ---
@@ -4,6 +4,7 @@
  */
 $allowed_levels = array(9);
 require_once 'bootstrap.php';
+log_in_required($allowed_levels);
 
 $active_nav = 'users';
 

--- users-edit.php ---
@@ -4,6 +4,7 @@
  */
 $allowed_levels = array(9, 8, 7);
 require_once 'bootstrap.php';
+log_in_required($allowed_levels);
 
 $active_nav = 'users';
 

--- users.php ---
@@ -4,6 +4,7 @@
  */
 $allowed_levels = array(9);
 require_once 'bootstrap.php';
+log_in_required($allowed_levels);
 
 $active_nav = 'users';
 

